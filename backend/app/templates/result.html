{% extends "base.html" %}

{% block content %}
<h2>Proposta Gerada</h2>

<div class="card">
    <p><strong>Cliente:</strong> {{ proposal.client_name }}</p>
    <p><strong>Servi莽o:</strong> {{ proposal.service }}</p>
    <p><strong>Valor:</strong> {{ proposal.price }}</p>
    <p><strong>Data:</strong> {{ proposal.created_at.strftime("%d/%m/%Y") if proposal.created_at else "" }}</p>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 6px;">
        <a href="/proposal/{{ proposal.id }}/pdf"><button type="button">Baixar PDF</button></a>
        <a href="/history"><button type="button">Ver Hist贸rico</button></a>
        <a href="/create"><button type="button">Criar Outra</button></a>
    </div>
</div>

<div class="card">
    <h3>Texto da Proposta</h3>

    {#  PORTO FINAL: corta tudo ap贸s "Pr贸ximos passos" (com varia莽玫es) #}
    {% set t = proposal.proposal_text %}
    {% set t = t.split('Pr贸ximos passos')[0] %}
    {% set t = t.split('Pr贸ximos Passos')[0] %}
    {% set t = t.split('**Pr贸ximos passos**')[0] %}
    {% set t = t.split('**Pr贸ximos Passos**')[0] %}
    {% set t = t.split('## Pr贸ximos passos')[0] %}
    {% set t = t.split('## Pr贸ximos Passos')[0] %}

    {#  Remove placeholders mais comuns #}
    {% set t = t
        | replace('[Seu Nome]', '')
        | replace('[Seu Contato]', '')
        | replace('[Seu Cargo]', '')
        | replace('[Telefone]', '')
        | replace('[telefone]', '')
        | replace('[E-mail]', '')
        | replace('[e-mail]', '')
        | replace('[Email]', '')
        | replace('[email]', '')
        | replace('[Nome da Empresa]', '')
        | replace('[nome da empresa]', '')
    %}

    {#  For莽a encerramento fixo #}
    {% set t = t.strip() ~ "\n\nAtenciosamente,\nEquipe Comercial" %}

    <textarea id="proposal_text" rows="18" readonly>{{ t }}</textarea>

    <p class="muted">Clique no texto acima para selecionar e copiar, ou use o bot茫o.</p>

    <button type="button" onclick="copyProposal()">Copiar texto</button>
</div>

<script>
function copyProposal() {
  const el = document.getElementById("proposal_text");
  el.select();
  el.setSelectionRange(0, 999999);
  try {
    document.execCommand("copy");
    alert("Texto copiado!");
  } catch (e) {
    alert("N茫o consegui copiar automaticamente. Selecione e copie manualmente.");
  }
}
</script>
{% endblock %}
